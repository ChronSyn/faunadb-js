<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <base data-ice="baseUrl" href="../../../">
  <title data-ice="title">test/model/builtin_test.js | FaunaDB API Document</title>
  <link type="text/css" rel="stylesheet" href="css/style.css">
  <link type="text/css" rel="stylesheet" href="css/prettify-tomorrow.css">
  <script src="script/prettify/prettify.js"></script>
  
  
  <script src="script/manual.js"></script>
</head>
<body class="layout-container" data-ice="rootContainer">

<header>
  <a href="./">Home</a>
  
  <a href="identifiers.html">Reference</a>
  <a href="source.html">Source</a>
  <a href="test.html" data-ice="testLink">Test</a>
  <a data-ice="repoURL" href="https://github.com/faunadb/faunadb-js" class="repo-url-github">Repository</a>
  <div class="search-box">
  <span>
    <img src="./image/search.png">
    <span class="search-input-edge"></span><input class="search-input"><span class="search-input-edge"></span>
  </span>
    <ul class="search-result"></ul>
  </div>
</header>

<nav class="navigation" data-ice="nav"><div>
  <ul>
    
  <li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/AsyncStream.js~AsyncStream.html">AsyncStream</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/Client.js~Client.html">Client</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/PageStream.js~PageStream.html">PageStream</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/errors.js~BadRequest.html">BadRequest</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/errors.js~FaunaError.html">FaunaError</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/errors.js~FaunaHTTPError.html">FaunaHTTPError</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/errors.js~InternalError.html">InternalError</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/errors.js~InvalidQuery.html">InvalidQuery</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/errors.js~InvalidValue.html">InvalidValue</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/errors.js~MethodNotAllowed.html">MethodNotAllowed</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/errors.js~NotFound.html">NotFound</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/errors.js~PermissionDenied.html">PermissionDenied</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/errors.js~Unauthorized.html">Unauthorized</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/errors.js~UnavailableError.html">UnavailableError</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/objects.js~Event.html">Event</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/objects.js~FaunaSet.html">FaunaSet</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/objects.js~Page.html">Page</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/objects.js~Ref.html">Ref</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-add">add</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-concat">concat</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-contains">contains</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-count">count</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-create">create</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-delete_expr">delete_expr</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-difference">difference</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-divide">divide</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-do_expr">do_expr</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-equals">equals</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-exists">exists</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-foreach">foreach</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-get">get</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-if_expr">if_expr</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-intersection">intersection</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-join">join</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-lambda">lambda</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-lambda_expr">lambda_expr</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-let_expr">let_expr</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-map">map</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-match">match</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-multiply">multiply</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-object">object</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-paginate">paginate</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-quote">quote</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-replace">replace</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-select">select</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-selectWithDefault">selectWithDefault</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-subtract">subtract</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-union">union</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-update">update</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-variable">variable</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">model</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/model/Builtin.js~Builtin.html">Builtin</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/model/Builtin.js~Class.html">Class</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/model/Builtin.js~ClassIndex.html">ClassIndex</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/model/Builtin.js~Database.html">Database</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/model/Builtin.js~Index.html">Index</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/model/Builtin.js~Key.html">Key</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/model/Codec.js~Codec.html">Codec</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/model/Field.js~Field.html">Field</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/model/Model.js~Model.html">Model</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-RefCodec">RefCodec</a></span></span></li>
</ul>
</div>
</nav>

<div class="content" data-ice="content"><h1 data-ice="title">test/model/builtin_test.js</h1>
<pre class="source-code line-number raw-source-code"><code class="prettyprint linenums" data-ice="content">import {assert} from &apos;chai&apos;
import {assertRejected, client, dbRef, rootClient} from &apos;../util&apos;
import {BadRequest, NotFound} from &apos;../../src/errors&apos;
import {Class, ClassIndex, Database, Index, Key} from &apos;../../src/model/Builtin&apos;
import Model from &apos;../../src/model/Model&apos;
import {Ref} from &apos;../../src/objects&apos;
import * as query from &apos;../../src/query&apos;

let MyModel

describe(&apos;Builtin&apos;, () =&gt; {
  before(async function() {
    MyModel = class MyModel extends Model {}
    MyModel.setup(&apos;bananas&apos;, {x: {}})
    await Class.createForModel(client, MyModel)
  })

  it(&apos;database&apos;, async function() {
    const name = &apos;builtin_test_database&apos;
    const db = new Database(rootClient, {name, api_version:&apos;2.0&apos;})
    assert.equal(db.name, name)
    assert.equal(db.api_version, &apos;2.0&apos;)

    await db.save()
    assert.isFalse(db.isNewInstance())
    const ref = db.ref
    assert.deepEqual(ref, new Ref(&apos;databases&apos;, name))

    await db.delete()

    // TODO: see test &apos;database existence&apos;.
    assertRejected(() =&gt; rootClient.get(ref), NotFound)
  })

  // See core issue #1975.
  if (false)
    it(&apos;database existence&apos;, async function() {
      assert.isFalse(await rootClient.query(
        query.exists(new Ref(&apos;databases&apos;, &apos;not_a_real_database_name&apos;))))
    })

  it(&apos;key&apos;, async function() {
    const database = await Database.get(rootClient, dbRef)
    const key = new Key(rootClient, {database: database.ref, role: &apos;server&apos;})
    await key.save()
    assert.isFalse(key.isNewInstance())
    assert(key.hashed_secret.length &gt; 0)
  })

  it(&apos;custom field&apos;, async function() {
    const database = await Database.get(rootClient, dbRef)
    Key.addField(&apos;x&apos;)
    const key = new Key(rootClient, {database: database.ref, role: &apos;server&apos;, x: 3})
    await key.save()
    assert.equal((await Key.get(rootClient, key.ref)).x, 3)
  })

  it(&apos;class&apos;, async function() {
    const cls = await Class.getForModel(client, MyModel)
    assert.isFalse(cls.isNewInstance())
    assert(cls.history_days &gt; 0)
    assert.equal(cls.name, MyModel.faunaClassName)

    cls.permissions = &apos;public&apos;
    await cls.save()

    assert.equal(cls.permissions, &apos;public&apos;)
    assert.equal((await Class.getForModel(client, MyModel)).permissions, &apos;public&apos;)
  })

  it(&apos;index&apos;, async function() {
    const idx = await Index.createForModel(client, MyModel, &apos;mooses_by_x&apos;, &apos;x&apos;)
    assert.deepEqual(await Index.getById(client, &apos;mooses_by_x&apos;), idx)

    const instance1 = await MyModel.create(client, {x: 1})
    await MyModel.create(client, {x: 2})
    const instance2 = await MyModel.create(client, {x: 1})

    assert.deepEqual((await MyModel.pageIndex(idx, 1)).data, [instance1, instance2])

    const all = await MyModel.streamIndex(idx, 1).all()
    assert.deepEqual(all, [instance1, instance2])
  })

  it(&apos;terms and values&apos;, async function() {
    class D extends Model {}
    D.setup(&apos;ds&apos;, {x: {}, y: {}})
    await Class.createForModel(client, D)

    const idx = await Index.createForModel(
      client,
      D,
      &apos;ds_by_x_y&apos;,
      [{path: &apos;data.x&apos;}, {path: &apos;data.y&apos;}])

    const d11 = await D.create(client, {x: 1, y: 1})
    await D.create(client, {x: 1, y: 2})
    await D.create(client, {x: 2, y: 1})

    assert.deepEqual((await D.pageIndex(idx, [1, 1])).data, [d11])
  })

  it(&apos;values&apos;, async function() {
    class E extends Model {}
    E.setup(&apos;es&apos;, {x: {}, y: {}, z: {}})
    await Class.createForModel(client, E)

    const index = await Index.createForModel(client, E, &apos;es_by_x_sorted&apos;, &apos;x&apos;, {
      values: [{path: &apos;data.y&apos;}, {path: &apos;data.z&apos;, reverse: true}]
    })

    const es = {}
    for (let x = 0; x &lt; 2; x = x + 1)
      for (let y = 0; y &lt; 2; y = y + 1)
        for (let z = 0; z &lt;  2; z = z + 1)
          es[`${x}${y}${z}`] = await E.create(client, {x, y, z})

    const expected = [&apos;001&apos;, &apos;000&apos;, &apos;011&apos;, &apos;010&apos;].map(key =&gt; es[key])

    assert.deepEqual((await E.pageIndex(index, 0)).data, expected)
    assert.deepEqual(await E.streamIndex(index, 0).all(), expected)
  })

  it(&apos;unique index&apos;, async function() {
    class F extends Model {}
    F.setup(&apos;fs&apos;, {x: {}})
    await Class.createForModel(client, F)

    const index = await Index.createForModel(client, F, &apos;fs_by_x&apos;, &apos;x&apos;, {unique: true})
    const instance = await F.create(client, {x: 1})
    // Unique index, so can&apos;t create another one.
    assertRejected(() =&gt; F.create(client, {x: 1}), BadRequest)

    assert.deepEqual(await index.getSingle(1), instance._current)
    assert.deepEqual(await F.getFromIndex(index, 1), instance)
    assertRejected(() =&gt; index.getSingle(2), NotFound)
  })

  it(&apos;class index&apos;, async function() {
    class M extends Model {}
    M.setup(&apos;test_list_model&apos;, {number: {}})
    await Class.createForModel(client, M)

    const idx = await ClassIndex.createForModel(client, M)
    assert.deepEqual(await ClassIndex.getForModel(client, M), idx)

    const ms = []
    for (let i = 0; i &lt; 10; i = i + 1)
      ms.push(await M.create(client, {number: i}))

    const ms_set = idx.match()
    const page = await M.page(client, ms_set, {size: 2})
    assert.deepEqual(page.data, [ms[0], ms[1]])
    const page2 = await M.page(client, ms_set, {size: 2, after: page.after})
    assert.deepEqual(page2.data, [ms[2], ms[3]])

    // List of all Ms should be exactly 100 in length
    const all = await M.streamIndex(idx, 1).all()
    assert.deepEqual(all, ms)
  })
})
</code></pre>

</div>

<footer class="footer">
  Generated by <a href="https://esdoc.org">ESDoc<span data-ice="esdocVersion">(0.4.1)</span></a>
</footer>

<script src="script/search_index.js"></script>
<script src="script/search.js"></script>
<script src="script/pretty-print.js"></script>
<script src="script/inherited-summary.js"></script>
<script src="script/test-summary.js"></script>
<script src="script/inner-link.js"></script>
<script src="script/patch-for-local.js"></script>
</body>
</html>
