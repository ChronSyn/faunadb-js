<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <base data-ice="baseUrl" href="../../">
  <title data-ice="title">test/query_test.js | FaunaDB API Document</title>
  <link type="text/css" rel="stylesheet" href="css/style.css">
  <link type="text/css" rel="stylesheet" href="css/prettify-tomorrow.css">
  <script src="script/prettify/prettify.js"></script>
  
  
  <script src="script/manual.js"></script>
</head>
<body class="layout-container" data-ice="rootContainer">

<header>
  <a href="./">Home</a>
  
  <a href="identifiers.html">Reference</a>
  <a href="source.html">Source</a>
  <a href="test.html" data-ice="testLink">Test</a>
  <a data-ice="repoURL" href="https://github.com/faunadb/faunadb-js" class="repo-url-github">Repository</a>
  <div class="search-box">
  <span>
    <img src="./image/search.png">
    <span class="search-input-edge"></span><input class="search-input"><span class="search-input-edge"></span>
  </span>
    <ul class="search-result"></ul>
  </div>
</header>

<nav class="navigation" data-ice="nav"><div>
  <ul>
    
  <li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/AsyncStream.js~AsyncStream.html">AsyncStream</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/Client.js~Client.html">Client</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/PageStream.js~PageStream.html">PageStream</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/errors.js~BadRequest.html">BadRequest</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/errors.js~FaunaError.html">FaunaError</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/errors.js~FaunaHTTPError.html">FaunaHTTPError</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/errors.js~InternalError.html">InternalError</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/errors.js~InvalidQuery.html">InvalidQuery</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/errors.js~InvalidValue.html">InvalidValue</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/errors.js~MethodNotAllowed.html">MethodNotAllowed</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/errors.js~NotFound.html">NotFound</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/errors.js~PermissionDenied.html">PermissionDenied</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/errors.js~Unauthorized.html">Unauthorized</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/errors.js~UnavailableError.html">UnavailableError</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/objects.js~Event.html">Event</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/objects.js~FaunaSet.html">FaunaSet</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/objects.js~Page.html">Page</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/objects.js~Ref.html">Ref</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-add">add</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-concat">concat</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-contains">contains</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-count">count</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-create">create</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-delete_expr">delete_expr</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-difference">difference</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-divide">divide</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-do_expr">do_expr</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-equals">equals</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-exists">exists</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-foreach">foreach</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-get">get</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-if_expr">if_expr</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-intersection">intersection</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-join">join</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-lambda">lambda</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-lambda_expr">lambda_expr</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-let_expr">let_expr</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-map">map</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-match">match</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-multiply">multiply</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-object">object</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-paginate">paginate</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-quote">quote</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-replace">replace</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-select">select</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-selectWithDefault">selectWithDefault</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-subtract">subtract</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-union">union</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-update">update</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-variable">variable</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">model</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/model/Builtin.js~Builtin.html">Builtin</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/model/Builtin.js~Class.html">Class</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/model/Builtin.js~ClassIndex.html">ClassIndex</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/model/Builtin.js~Database.html">Database</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/model/Builtin.js~Index.html">Index</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/model/Builtin.js~Key.html">Key</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/model/Codec.js~Codec.html">Codec</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/model/Field.js~Field.html">Field</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/model/Model.js~Model.html">Model</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-RefCodec">RefCodec</a></span></span></li>
</ul>
</div>
</nav>

<div class="content" data-ice="content"><h1 data-ice="title">test/query_test.js</h1>
<pre class="source-code line-number raw-source-code"><code class="prettyprint linenums" data-ice="content">import {assert} from &apos;chai&apos;
import {BadRequest, NotFound} from &apos;../src/errors&apos;
import {FaunaSet} from &apos;../src/objects&apos;
import * as query from &apos;../src/query&apos;
import {assertRejected, client} from &apos;./util&apos;

let class_ref, nIndexRef, mIndexRef, refN1, refM1, refN1M1

describe(&apos;query&apos;, () =&gt; {
  before(async function() {
    class_ref = (await client.post(&apos;classes&apos;, {name: &apos;widgets&apos;})).ref

    nIndexRef = (await client.post(&apos;indexes&apos;, {
      name: &apos;widgets_by_n&apos;,
      source: class_ref,
      path: &apos;data.n&apos;,
      active: true
    })).ref

    mIndexRef = (await client.post(&apos;indexes&apos;, {
      name: &apos;widgets_by_m&apos;,
      source: class_ref,
      path: &apos;data.m&apos;,
      active: true
    })).ref

    refN1 = (await create({n: 1})).ref
    refM1 = (await create({m: 1})).ref
    refN1M1 = (await create({n: 1, m: 1})).ref
  })

  it(&apos;let/var&apos;, async function() {
    await assertQuery(query.let_expr({x: 1}, query.variable(&apos;x&apos;)), 1)
  })

  it(&apos;if&apos;, async function() {
    await assertQuery(query.if_expr(true, &apos;t&apos;, &apos;f&apos;), &apos;t&apos;)
    await assertQuery(query.if_expr(false, &apos;t&apos;, &apos;f&apos;), &apos;f&apos;)
  })

  it(&apos;do&apos;, async function() {
    const ref = (await create()).ref
    await assertQuery(query.do_expr(query.delete_expr(ref), 1), 1)
    await assertQuery(query.exists(ref), false)
  })

  it(&apos;object&apos;, async function() {
    const obj = query.object({x: query.let_expr({x: 1}, query.variable(&apos;x&apos;))})
    await assertQuery(obj, {x: 1})
  })

  it(&apos;quote&apos;, async function() {
    const quoted = query.let_expr({x: 1}, query.variable(&apos;x&apos;))
    await assertQuery(query.quote(quoted), quoted)
  })

  it(&apos;lambda&apos;, () =&gt; {
    assert.deepEqual(
      query.lambda(a =&gt; query.add(a, a)),
      {lambda: &apos;auto0&apos;, expr: {add: [{var: &apos;auto0&apos;}, {var: &apos;auto0&apos;}]}})

    assert.deepEqual(
      query.lambda(a =&gt; query.lambda(b =&gt; query.lambda(c =&gt; [a, b, c]))),
      {
        lambda: &apos;auto0&apos;,
        expr: {
          lambda: &apos;auto1&apos;,
          expr: {
            lambda: &apos;auto2&apos;,
            expr: [{var: &apos;auto0&apos;}, {var: &apos;auto1&apos;}, {var: &apos;auto2&apos;}]}
          }
      })

    // Error in function should not affect future queries.
    try { query.lambda(() =&gt; { throw new Error() }) } catch (err) { }

    assert.deepEqual(query.lambda(a =&gt; a), {lambda: &apos;auto0&apos;, expr: {var: &apos;auto0&apos;}})
  })

  it(&apos;map&apos;, async function() {
    const double = query.lambda(x =&gt; query.multiply([2, x]))
    await assertQuery(query.map(double, [1, 2, 3]), [2, 4, 6])

    const getN = query.lambda(x =&gt; query.select([&apos;data&apos;, &apos;n&apos;], query.get(x)))
    const page = query.paginate(nSet(1))
    const ns = query.map(getN, page)
    assert.deepEqual((await client.query(ns)).data, [1, 1])
  })

  it(&apos;foreach&apos;, async function() {
    const refs = [(await create()).ref, (await create()).ref]
    await client.query(
      query.foreach(query.lambda(query.delete_expr), refs))
    for (const ref of refs)
      await assertQuery(query.exists(ref), false)
  })

  it(&apos;get&apos;, async function() {
    const instance = await create()
    await assertQuery(query.get(instance.ref), instance)
  })

  it(&apos;paginate&apos;, async function() {
    const testSet = nSet(1)
    await assertQuery(query.paginate(testSet), {data: [refN1, refN1M1]})
    await assertQuery(query.paginate(testSet, {size: 1}), {data: [refN1], after: refN1M1})
    await assertQuery(query.paginate(testSet, {sources: true}), {
      data: [
        {sources: [new FaunaSet(testSet)], value: refN1},
        {sources: [new FaunaSet(testSet)], value: refN1M1}
      ]
    })
  })

  it(&apos;exists&apos;, async function() {
    const ref = (await create()).ref
    await assertQuery(query.exists(ref), true)
    await client.query(query.delete_expr(ref))
    await assertQuery(query.exists(ref), false)
  })

  it(&apos;count&apos;, async function() {
    await create({n: 123})
    await create({n: 123})
    const instances = nSet(123)
    // `count` is currently only approximate. Should be 2.
    assert.typeOf(await client.query(query.count(instances)), &apos;number&apos;)
  })

  it(&apos;create&apos;, async function() {
    const instance = await create()
    assert(&apos;ref&apos; in instance)
    assert(&apos;ts&apos; in instance)
    assert.deepEqual(instance.class, class_ref)
  })

  it(&apos;update&apos;, async function() {
    const ref = (await create()).ref
    const got = await client.query(query.update(ref, query.quote({data: {m: 9}})))
    assert.deepEqual(got.data, {n: 0, m: 9})
  })

  it(&apos;replace&apos;, async function() {
    const ref = (await create()).ref
    const got = await client.query(query.replace(ref, query.quote({data: {m: 9}})))
    assert.deepEqual(got.data, {m: 9})
  })

  it(&apos;delete&apos;, async function() {
    const ref = (await create()).ref
    await client.query(query.delete_expr(ref))
    await assertQuery(query.exists(ref), false)
  })

  it(&apos;match&apos;, async function() {
    await assertSet(nSet(1), [refN1, refN1M1])
  })

  it(&apos;union&apos;, async function() {
    await assertSet(query.union(nSet(1), mSet(1)), [refN1, refM1, refN1M1])
  })

  it(&apos;intersection&apos;, async function() {
    await assertSet(query.intersection(nSet(1), mSet(1)), [refN1M1])
  })

  it(&apos;difference&apos;, async function() {
    await assertSet(query.difference(nSet(1), mSet(1)), [refN1]) // but not refN1M1
  })

  it(&apos;join&apos;, async function() {
    const referenced = [
      (await create({n: 12})).ref,
      (await create({n: 12})).ref
    ]
    const referencers = [
      (await create({m: referenced[0]})).ref,
      (await create({m: referenced[1]})).ref
    ]

    const source = nSet(12)
    await assertSet(source, referenced)

    // For each obj with n=12, get the set of elements whose data.m refers to it.
    const joined = query.join(
      source,
      query.lambda(x =&gt; query.match(x, mIndexRef)))
    await assertSet(joined, referencers)
  })

  it(&apos;equals&apos;, async function() {
    await assertQuery(query.equals(1, 1, 1), true)
    await assertQuery(query.equals(1, 1, 2), false)
    await assertQuery(query.equals(1), true)
    await assertBadQuery(query.equals())
  })

  it(&apos;concat&apos;, async function() {
    await assertQuery(query.concat(&apos;a&apos;, &apos;b&apos;, &apos;c&apos;), &apos;abc&apos;)
    await assertQuery(query.concat(), &apos;&apos;)
  })

  it(&apos;contains&apos;, async function() {
    const obj = query.quote({a: {b: 1}})
    await assertQuery(query.contains([&apos;a&apos;, &apos;b&apos;], obj), true)
    await assertQuery(query.contains(&apos;a&apos;, obj), true)
    await assertQuery(query.contains([&apos;a&apos;, &apos;c&apos;], obj), false)
  })

  it(&apos;select&apos;, async function() {
    const obj = query.quote({a: {b: 1}})
    await assertQuery(query.select(&apos;a&apos;, obj), {b: 1})
    await assertQuery(query.select([&apos;a&apos;, &apos;b&apos;], obj), 1)
    await assertQuery(query.selectWithDefault(&apos;c&apos;, obj, null), null)
    await assertBadQuery(query.select(&apos;c&apos;, obj), NotFound)
  })

  it(&apos;select for array&apos;, async function() {
    const arr = [1, 2, 3]
    await assertQuery(query.select(2, arr), 3)
    await assertBadQuery(query.select(3, arr), NotFound)
  })

  it(&apos;add&apos;, async function() {
    await assertQuery(query.add(2, 3, 5), 10)
    await assertBadQuery(query.add())
  })

  it(&apos;multiply&apos;, async function() {
    await assertQuery(query.multiply(2, 3, 5), 30)
    await assertBadQuery(query.multiply())
  })

  it(&apos;subtract&apos;, async function() {
    await assertQuery(query.subtract(2, 3, 5), -6)
    await assertQuery(query.subtract(2), 2)
    await assertBadQuery(query.subtract())
  })

  it(&apos;divide&apos;, async function() {
    // TODO: can&apos;t make this query because 2.0 === 2
    // await assertQuery(query.divide(2, 3, 5), 2/15)
    await assertQuery(query.divide(2), 2)
    await assertBadQuery(query.divide(1, 0))
    await assertBadQuery(query.divide())
  })

  it(&apos;varargs&apos;, async function() {
    // Works for lists too
    await assertQuery(query.add([2, 3, 5]), 10)
    // Works for a variable equal to a list
    await assertQuery(query.let_expr({x: [2, 3, 5]}, query.add(query.variable(&apos;x&apos;))), 10)
  })
})

const
  create = (data={}) =&gt; {
    if (data.n === undefined)
      data.n = 0
    return client.query(query.create(class_ref, query.quote({data})))
  },
  nSet = n =&gt;
    query.match(n, nIndexRef),
  mSet = m =&gt;
    query.match(m, mIndexRef)

async function assertQuery(query, expected) {
  assert.deepEqual(await client.query(query), expected)
}
async function assertBadQuery(query, errorType=BadRequest) {
  assertRejected(client.query(query), errorType)
}
async function assertSet(set, expected) {
  assert.deepEqual(await getSetContents(set), expected)
}
async function getSetContents(set) {
  return (await client.query(query.paginate(set, {size: 1000}))).data
}
</code></pre>

</div>

<footer class="footer">
  Generated by <a href="https://esdoc.org">ESDoc<span data-ice="esdocVersion">(0.4.1)</span></a>
</footer>

<script src="script/search_index.js"></script>
<script src="script/search.js"></script>
<script src="script/pretty-print.js"></script>
<script src="script/inherited-summary.js"></script>
<script src="script/test-summary.js"></script>
<script src="script/inner-link.js"></script>
<script src="script/patch-for-local.js"></script>
</body>
</html>
