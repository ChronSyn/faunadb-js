<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: src/PageHelper.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: src/PageHelper.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>'use strict';

var query = require('./query');
var objectAssign = require('object-assign');
var Promise = require('es6-promise').Promise;

/**
 * A FaunaDB Lambda expression to be passed into one of the collection
 * functions: Map or Filter.
 *
 * @callback PageHelper~collectionFunction
 * @param {any} var
 *   The variable passed in by FaunaDB when this Lambda
 *   function is executed.
 * @return {Expr}
 *   The FaunaDB query expression to be returned by this Lambda.
 */

/**
 * @callback PageHelper~eachPageFunction
 * @param {Object} page
 *   A page returned by FaunaDB's Paginate function.
 */

/**
 * @callback PageHelper~eachItemFunction
 * @param {Object} item
 *   An item contained in a page returned by FaunaDB's Paginate function.
 */

/**
 * A wrapper that provides a helpful API for consuming FaunaDB pages.
 *
 * Generally this is constructed through the {@link Client#paginate} method.
 *
 * @param {Client} client
 *   The FaunaDB client used to paginate.
 * @param {Object} set
 *   The set to paginate.
 * @param {Object} params
 *   Parameters to be passed to the FaunaDB Paginate function.
 * @constructor
 */
function PageHelper(client, set, params) {
  if (params === undefined) {
    params = {};
  }

  this.reverse = false;
  this.params = {};
  this.cursor = undefined;
  objectAssign(this.params, params);

  if ('before' in params &amp;&amp; 'after' in params) {
    throw 'Cursor directions "before" and "after"j are exclusive.';
  }

  if ('before' in params) {
    this.cursor = params.before;
    this.reverse = true;

    delete this.params.before;
  } else if ('after' in params) {
    this.cursor = params.after;

    delete this.params.after;
  }

  this.client = client;
  this.set = set;

  /**
   * @member {Array.&lt;Function>}
   * @type {Array.&lt;Function>}
   * @private
   */
  this._fauna_functions = [];
}

/**
 * Wraps the set to be paginated with a FaunaDB Map function.
 * As this function is executed on the server, the `lambda` param must
 * return a valid query expression.
 *
 * @param {PageHelper~collectionFunction} lambda
 *   The Lambda expression to be passed into the Map function.
 * @return {PageHelper}
 *
 */
PageHelper.prototype.map = function(lambda) {
  var rv = this.clone();
  rv._fauna_functions.push(function(q) { return query.map(q, lambda); });
  return rv;
};

/**
 * Wraps the set to be paginated with a FaunaDB Filter funciton.
 * As this function is executed on the server, the `lambda` param must
 * return a valid query expression.
 *
 * @param {PageHelper~collectionFunction} lambda
 *   The lambda expression to be passed into the Filter function.
 * @return {PageHelper}
 */
PageHelper.prototype.filter = function(lambda) {
  var rv = this.clone();
  rv._fauna_functions.push(function(q) { return query.filter(q, lambda); });
  return rv;
};

/**
 * Executes the provided function for each page.
 *
 * @param {PageHelper~eachPageFunction} lambda
 *   A function to be executed for each page.
 * @returns {external:Promise.&lt;void>}
 */
PageHelper.prototype.eachPage = function(lambda) {
  return this._next_page(this.cursor).then(this._handle_page(lambda));
};

/**
 * Executes the provided function for each item in each page.
 *
 * @param {PageHelper~eachItemFunction} lambda
 *   A function to be executed for each item in each page.
 * @returns {external:Promise.&lt;void>}
 */
PageHelper.prototype.eachItem = function(lambda) {
  return this._next_page(this.cursor).then(this._handle_page(function(page) {
    page.forEach(lambda);
  }));
};

PageHelper.prototype._handle_page = function(lambda) {
  var self = this;
  return function (page) {
    lambda(page.data);

    var next_cursor;
    if (self.reverse) {
      next_cursor = page.before;
    } else {
      next_cursor = page.after;
    }

    if (next_cursor !== undefined) {
      return self._next_page(next_cursor).then(self._handle_page(lambda));
    } else {
      return Promise.resolve();
    }
  };
};

/**
 *
 * @returns {external:Promise.&lt;Object>}
 * @private
 */
PageHelper.prototype._next_page = function(cursor) {
  var opts = {};
  objectAssign(opts, this.params);

  if (cursor !== undefined) {
    if (this.reverse) {
      opts.before = cursor;
    } else {
      opts.after = cursor;
    }
  } else {
    if (this.reverse) {
      opts.before = null;
    }
  }

  var q = query.paginate(this.set, opts);

  if (this._fauna_functions.length > 0) {
    this._fauna_functions.forEach(function(lambda) {
      q = lambda(q);
    });
  }

  return this.client.query(q);
};

/**
 * @private
 * @returns {PageHelper}
 */
PageHelper.prototype.clone = function() {
  return Object.create(PageHelper.prototype, {
    client: { value: this.client },
    set: { value: this.set },
    _fauna_functions: { value: this._fauna_functions },
    reverse: { value: this.reverse },
    cursor: { value: this.cursor }
  });
};

module.exports = PageHelper;
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Modules</h3><ul><li><a href="module-clientLogger.html">clientLogger</a></li><li><a href="module-query.html">query</a></li></ul><h3>Externals</h3><ul><li><a href="external-Promise.html">Promise</a></li></ul><h3>Classes</h3><ul><li><a href="BadRequest.html">BadRequest</a></li><li><a href="Client.html">Client</a></li><li><a href="Expr.html">Expr</a></li><li><a href="FaunaError.html">FaunaError</a></li><li><a href="FaunaHTTPError.html">FaunaHTTPError</a></li><li><a href="InternalError.html">InternalError</a></li><li><a href="InvalidValue.html">InvalidValue</a></li><li><a href="MethodNotAllowed.html">MethodNotAllowed</a></li><li><a href="NotFound.html">NotFound</a></li><li><a href="PageHelper.html">PageHelper</a></li><li><a href="PermissionDenied.html">PermissionDenied</a></li><li><a href="RequestResult.html">RequestResult</a></li><li><a href="Unauthorized.html">Unauthorized</a></li><li><a href="UnavailableError.html">UnavailableError</a></li><li><a href="Value.html">Value</a></li><li><a href="Value.FaunaDate.html">FaunaDate</a></li><li><a href="Value.FaunaTime.html">FaunaTime</a></li><li><a href="Value.Ref.html">Ref</a></li><li><a href="Value.SetRef.html">SetRef</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.4.0</a> on Tue Jun 21 2016 14:39:32 GMT-0700 (PDT)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
